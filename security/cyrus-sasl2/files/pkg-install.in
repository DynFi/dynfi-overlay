#!/bin/sh -x
#
#	$FreeBSD$
#
# Created by: stb@FreeBSD.org for the cyrus imap server
# Added to the cyrus-sasl port by hetzels@westbend.net

#set -vx

PKG_BATCH=${BATCH:=NO}
PKG_PREFIX=${PKG_ROOTDIR}/${PKG_PREFIX:=/usr/local}
SASLDB_NAME=%%SASLDB_NAME%%
SASLDB_NAME=${SASLDB_NAME:+${PKG_PREFIX}/etc/%%SASLDB_NAME%%}
SASLDB_PATH=${PKG_PREFIX}/etc/
CYRUS_USER=${CYRUS_USER:=%%CYRUS_USER%%}
CYRUS_GROUP=${CYRUS_GROUP:=%%CYRUS_GROUP%%}

create_sasldb() {
	export LD_LIBRARY_PATH=${PKG_PREFIX}/lib/
	dbname=$(echo %%SASLDB_NAME%% | sed 's/\.db//')
	if [ ! -f ${SASLDB_NAME} ]; then
		mkdir -p ${PKG_PREFIX}/etc
		echo ${SASLDB_NAME}
		echo "${SASLDB_PATH}/${dbname}"
		echo "test" | ${PKG_PREFIX}/sbin/saslpasswd2 -f ${SASLDB_PATH}/sasldb2.db -p -c ${CYRUS_USER}
		ls -l ${PKG_PREFIX}/etc/
		if [ `${PKG_PREFIX}/sbin/sasldblistusers2 -f ${SASLDB_PATH}/${dbname} | wc -l` -eq 0 ] ; then
                        echo "WARNING: Failed to create ${SASLDB_NAME}"
                else
			${PKG_PREFIX}/sbin/saslpasswd2 -f ${SASLDB_PATH}/${dbname} -d ${CYRUS_USER}
			chown ${CYRUS_USER}:mail ${SASLDB_NAME}
			chmod 640 ${SASLDB_NAME}
			if [ -f ${SASLDB_NAME}-lock ]; then
				chown ${CYRUS_USER}:mail ${SASLDB_NAME}-lock
				chmod 640 ${SASLDB_NAME}-lock
			fi
		fi
	fi
}

case $2 in
	POST-INSTALL)
		if [ "${PKG_BATCH}" = "NO" ]; then
			if [ -n "${SASLDB_NAME}" ]; then
				create_sasldb
			fi
		elif [ -n "${SASLDB_NAME}" -a ! -f ${SASLDB_NAME} ]; then
			echo "*** We do not create ${SASLDB_NAME} automatically in"
			echo "*** BATCH mode.  Please create it by yourself.  It should be"
			echo "*** owner: ${CYRUS_USER}, group: mail, mode: 0640."
		fi
		;;
esac
